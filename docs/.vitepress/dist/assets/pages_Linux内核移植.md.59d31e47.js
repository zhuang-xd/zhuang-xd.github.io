import{_ as s,o as a,c as n,V as l}from"./chunks/framework.7ae304b1.js";const p="/assets/20230625223640018.59cbfd6c.png",o="/assets/20230625223629714.9244a4f1.png",e="/assets/20230625223623277.36e13dbd.png",t="/assets/20230625215605264.287a67a0.png",c="/assets/20230625224252850.6e68be66.png",C="/assets/20230625222600476.652d06bd.png",u=JSON.parse('{"title":"Linux内核移植","description":"","frontmatter":{"tags":"笔记","date":"2023-06-25T00:00:00.000Z","title":"Linux内核移植","sidebar":false},"headers":[],"relativePath":"pages/Linux内核移植.md","filePath":"pages/Linux内核移植.md","lastUpdated":1687704951000}'),r={name:"pages/Linux内核移植.md"},y=l(`<h1 id="linux内核移植" tabindex="-1">Linux内核移植 <a class="header-anchor" href="#linux内核移植" aria-label="Permalink to &quot;Linux内核移植&quot;">​</a></h1><h2 id="分析内核源码" tabindex="-1">分析内核源码 <a class="header-anchor" href="#分析内核源码" aria-label="Permalink to &quot;分析内核源码&quot;">​</a></h2><blockquote><p>下载源码 <a href="https://st.com/content/ccc/resource/technical/sw-updater/firmware2/group0/2b/04/61/eb/4c/83/4d/3d/stm32cube_standard_a7_bsp_components_tf_a/files/SOURCES-tf-a-stm32mp1-openstlinux-5-10-dunfell-mp1-21-11-17_tar.xz/_jcr_content/translations/en.SOURCES-tf-a-stm32mp1-openstlinux-5-10-dunfell-mp1-21-11-17_tar.xz" target="_blank" rel="noreferrer">en.SOURCES-stm32mp1-openstlinux-5.10-dunfell-mp1-21-11-17_tar_v3.1.0.xz</a></p></blockquote><h3 id="阅读-readme" tabindex="-1">阅读 README <a class="header-anchor" href="#阅读-readme" aria-label="Permalink to &quot;阅读 README&quot;">​</a></h3><blockquote><p><code>stm32mp1-openstlinux-5.10-dunfell-mp1-21-11-17/sources/arm-ostl-linux-gnueabi/linux-stm32mp-5.10.61-stm32mp-r2-r0\\README.HOW_TO.txt</code></p></blockquote><div class="language-txt"><button title="Copy Code" class="copy"></button><span class="lang">txt</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">Compilation of kernel:</span></span>
<span class="line"><span style="color:#A6ACCD;">1. Pre-requisite</span></span>
<span class="line"><span style="color:#A6ACCD;">2. Initialise cross-compilation via SDK</span></span>
<span class="line"><span style="color:#A6ACCD;">3. Prepare kernel source code</span></span>
<span class="line"><span style="color:#A6ACCD;">4. Manage the kernel source code</span></span>
<span class="line"><span style="color:#A6ACCD;">5. Configure kernel source code</span></span>
<span class="line"><span style="color:#A6ACCD;">6. Compile kernel source code</span></span>
<span class="line"><span style="color:#A6ACCD;">7. Update software on board</span></span></code></pre></div><ol><li>需要安装库信息：</li></ol><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">Ubuntu:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">apt-get</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">u-boot-tools</span></span></code></pre></div><ol start="2"><li>解压内核源码</li></ol><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">$&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">tar</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">xfJ</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">linux-5.10.61.tar.xz</span></span></code></pre></div><ol start="3"><li>进入内核源码目录</li></ol><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">$&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">cd</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">linux-5.10.61</span></span></code></pre></div><ol start="4"><li>对内核源码进行打补丁</li></ol><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">$&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">p</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">in</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">\`</span><span style="color:#FFCB6B;">ls</span><span style="color:#C3E88D;"> -1 ../</span><span style="color:#A6ACCD;">*</span><span style="color:#C3E88D;">.patch</span><span style="color:#89DDFF;">\`</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">do</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">patch</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-p1</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> $p</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">done</span></span></code></pre></div><ol start="5"><li>配置补丁文件列表的相关信息</li></ol><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">make</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ARCH=arm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">multi_v7_defconfig</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">fragment</span><span style="color:#A6ACCD;">*</span><span style="color:#C3E88D;">.config</span></span></code></pre></div><ol start="6"><li>编译内核源码</li></ol><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">make</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ARCH=arm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">uImage</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">vmlinux</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">dtbs</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">LOADADDR=</span><span style="color:#F78C6C;">0xC2000040</span></span></code></pre></div><ol start="7"><li>采用模块化方式进行编译</li></ol><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">$</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">make</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ARCH=arm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">modules</span></span></code></pre></div><ol start="8"><li>产生文件路径： <ul><li>uImage镜像文件：内核源码/arch/arm/boot/uImage</li><li>设备树镜像文件：内核源码/arch/arm/boot/dts/st*.dtb</li></ul></li></ol><h3 id="内核目录" tabindex="-1">内核目录 <a class="header-anchor" href="#内核目录" aria-label="Permalink to &quot;内核目录&quot;">​</a></h3><ol><li>对内核源码进行解压</li></ol><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#82AAFF;">cd</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">~/FSMP1A/linux-stm32mp-5.10.61-stm32mp-r2-r0</span></span>
<span class="line"><span style="color:#FFCB6B;">tar</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-vxf</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">linux-5.10.61.tar.xz</span></span></code></pre></div><ol start="2"><li>进入linux内核源码目录下</li></ol><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#82AAFF;">cd</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">linux-5.10.61/</span></span></code></pre></div><ol start="3"><li>目录介绍</li></ol><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">arch</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">--------</span><span style="color:#89DDFF;">&gt;</span><span style="color:#C3E88D;">存放各个架构的内容</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">arm/X86架构</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#FFCB6B;">block</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--------</span><span style="color:#89DDFF;">&gt;</span><span style="color:#C3E88D;">块设备相关内容</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#FFCB6B;">certs</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">--------</span><span style="color:#89DDFF;">&gt;</span><span style="color:#C3E88D;">列表信息</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#FFCB6B;">COPYING</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--------</span><span style="color:#89DDFF;">&gt;</span><span style="color:#C3E88D;">内核描述文档</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#FFCB6B;">CREDITS</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--------</span><span style="color:#89DDFF;">&gt;</span><span style="color:#C3E88D;">内核贡献者列表</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#FFCB6B;">Documentation--------&gt;内核帮助文档（所以内核的信息都可以在这个帮助文档中找到）</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#FFCB6B;">drivers</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--------</span><span style="color:#89DDFF;">&gt;</span><span style="color:#C3E88D;">驱动相关代码</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#FFCB6B;">fs</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">--------</span><span style="color:#89DDFF;">&gt;</span><span style="color:#C3E88D;">文件系统相关代码</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#FFCB6B;">include</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--------</span><span style="color:#89DDFF;">&gt;</span><span style="color:#C3E88D;">内核中头文件目录</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#FFCB6B;">init</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--------</span><span style="color:#89DDFF;">&gt;</span><span style="color:#C3E88D;">内核初始化相关代码</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#FFCB6B;">ipc--------&gt;内核中进程间通信相关代码</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#FFCB6B;">Kbuild</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--------</span><span style="color:#89DDFF;">&gt;</span><span style="color:#C3E88D;">Makefile会调用这个文件完成内核编译</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#FFCB6B;">Kconfig</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--------</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">生成基于图形化菜单界面信息</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">make</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">menuconfig</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#FFCB6B;">lib</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">--------</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">内核库相关信息</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#FFCB6B;">LICENSES</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--------</span><span style="color:#89DDFF;">&gt;</span><span style="color:#C3E88D;">遵循GPL协议</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#FFCB6B;">MAINTAINERS</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--------</span><span style="color:#89DDFF;">&gt;</span><span style="color:#C3E88D;">内核当前贡献者列表</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#FFCB6B;">Makefile</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--------</span><span style="color:#89DDFF;">&gt;</span><span style="color:#C3E88D;">工程管理文件</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#FFCB6B;">scripts</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--------</span><span style="color:#89DDFF;">&gt;</span><span style="color:#C3E88D;">和编译相关目录（shell脚本）</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#FFCB6B;">security--------&gt;内核安全相关代码</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#FFCB6B;">tools--------&gt;内核源码工具目录</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#FFCB6B;">crypto</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--------</span><span style="color:#89DDFF;">&gt;</span><span style="color:#C3E88D;">内核加密算法</span></span></code></pre></div><h2 id="移植内核" tabindex="-1">移植内核 <a class="header-anchor" href="#移植内核" aria-label="Permalink to &quot;移植内核&quot;">​</a></h2><h3 id="编译内核" tabindex="-1">编译内核 <a class="header-anchor" href="#编译内核" aria-label="Permalink to &quot;编译内核&quot;">​</a></h3><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">1.进入linux内核源码目录，配置交叉编译工具链，打开Makefile文件，搜索：CROSS_COMPILE</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#FFCB6B;">370</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ARCH</span><span style="color:#A6ACCD;">        </span><span style="color:#C3E88D;">?=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">$(</span><span style="color:#FFCB6B;">SUBARCH</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#FFCB6B;">371</span><span style="color:#A6ACCD;">      </span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#FFCB6B;">更改为：</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">370</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ARCH</span><span style="color:#A6ACCD;">        </span><span style="color:#C3E88D;">?=</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">arm</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">371</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">CROSS_COMPILE</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">:=</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">arm-linux-gnueabihf-</span><span style="color:#A6ACCD;">                      </span></span>
<span class="line"><span style="color:#FFCB6B;">2.对内核源码进行打补丁</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#89DDFF;font-style:italic;">for</span><span style="color:#A6ACCD;"> p </span><span style="color:#89DDFF;font-style:italic;">in</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">\`</span><span style="color:#FFCB6B;">ls</span><span style="color:#C3E88D;"> -1 ../</span><span style="color:#A6ACCD;">*</span><span style="color:#C3E88D;">.patch</span><span style="color:#89DDFF;">\`</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">do</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">patch</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-p1</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#A6ACCD;"> $p</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;font-style:italic;">done</span></span>
<span class="line"><span style="color:#FFCB6B;">3.配置补丁文件列表的相关信息</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#FFCB6B;">make</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ARCH=arm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">multi_v7_defconfig</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">fragment</span><span style="color:#A6ACCD;">*</span><span style="color:#C3E88D;">.config</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">成功现象：</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># configuration written to .config </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;"># </span></span>
<span class="line"><span style="color:#FFCB6B;">4.因为FSMP1A开发板是参考DK1平台进行设计，所以将DK1公板设备树相关内容，复制为FSMP1A设备树</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">1）进入linux-5.10.61/arch/arm/boot/dts设备树目录，复制相关内容</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">cp</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">stm32mp157a-dk1.dts</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">stm32mp157a-fsmp1a.dts</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">cp</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">stm32mp15xx-dkx.dtsi</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">stm32mp15xx-fsmp1x.dtsi</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">2）进入linux-5.10.61/arch/arm/boot/dts设备树目录，打开</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">vi</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">stm32mp157a-fsmp1a.dts</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">13</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">#include &quot;stm32mp15xx-fsmp1x.dtsi&quot;  --------&gt; 这一行为修改内容 </span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">14</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">15</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">{</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">16</span><span style="color:#A6ACCD;">     </span><span style="color:#C3E88D;">model</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">HQYJ STM32MP157A-FSMP1A Discovery Board</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">--------&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">这一行为修改内容</span><span style="color:#A6ACCD;">                                                     </span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">17</span><span style="color:#A6ACCD;">     </span><span style="color:#C3E88D;">compatible</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">hqyj,stm32mp157a-fsmp1a</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">,</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">hqyj,stm32mp157</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">--------&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">这一行为修改内容</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#FFCB6B;">3）进入linux-5.10.61/arch/arm/boot/dts设备树目录，打开</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">vi</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Makefile</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">1097</span><span style="color:#A6ACCD;">     </span><span style="color:#C3E88D;">stm32mp157a-dk1.dtb</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#F78C6C;">1098</span><span style="color:#A6ACCD;">     </span><span style="color:#C3E88D;">stm32mp157a-fsmp1a.dtb</span><span style="color:#A6ACCD;"> \\    </span><span style="color:#C3E88D;">--------</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">这一行为修改内容</span><span style="color:#A6ACCD;">   </span></span>
<span class="line"><span style="color:#FFCB6B;">5.在内核源码目录下，编译内核源码</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">time</span><span style="color:#A6ACCD;"> make -j4 ARCH=arm uImage vmlinux dtbs LOADADDR=0xC2000000 </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">解释：</span></span>
<span class="line"><span style="color:#A6ACCD;">     time：显示编译时间</span></span>
<span class="line"><span style="color:#A6ACCD;">     ARCH</span><span style="color:#89DDFF;">=</span><span style="color:#C3E88D;">arm：指定arm架构</span></span>
<span class="line"><span style="color:#A6ACCD;">      </span><span style="color:#FFCB6B;">uImage：编译生成uImage镜像文件</span></span>
<span class="line"><span style="color:#A6ACCD;">       </span><span style="color:#FFCB6B;">vmlinux：elf可执行文件</span></span>
<span class="line"><span style="color:#A6ACCD;">        </span><span style="color:#FFCB6B;">dtbs：编译设备树</span></span>
<span class="line"><span style="color:#A6ACCD;">         LOADADDR</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">0xC2000000</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">：指定加载地址</span></span>
<span class="line"><span style="color:#FFCB6B;">6.成功现象：</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">OBJCOPY</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">arch/arm/boot/zImage</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">Kernel:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">arch/arm/boot/zImage</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">is</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ready</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">UIMAGE</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">arch/arm/boot/uImage</span></span>
<span class="line"><span style="color:#FFCB6B;">Image</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Name:</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">Linux-5.10.61</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#FFCB6B;">Created:</span><span style="color:#A6ACCD;">      </span><span style="color:#C3E88D;">Wed</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Jun</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">21</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">17</span><span style="color:#C3E88D;">:04:58</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">2023</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#FFCB6B;">Image</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Type:</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">ARM</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Linux</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Kernel</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Image</span><span style="color:#A6ACCD;"> (uncompressed) </span></span>
<span class="line"><span style="color:#FFCB6B;">Data</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Size:</span><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">7172008</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Bytes</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">7003.91</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">KiB</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">6.84</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">MiB</span></span>
<span class="line"><span style="color:#FFCB6B;">Load</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Address:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">c2000000</span></span>
<span class="line"><span style="color:#FFCB6B;">Entry</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Point:</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">c2000000</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">Kernel:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">arch/arm/boot/uImage</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">is</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">readyreal</span><span style="color:#A6ACCD;">	</span><span style="color:#F78C6C;">5</span><span style="color:#C3E88D;">m46.234s</span></span>
<span class="line"><span style="color:#FFCB6B;">user</span><span style="color:#A6ACCD;">	</span><span style="color:#F78C6C;">19</span><span style="color:#C3E88D;">m0.143s</span></span>
<span class="line"><span style="color:#FFCB6B;">sys</span><span style="color:#A6ACCD;">	</span><span style="color:#F78C6C;">2</span><span style="color:#C3E88D;">m3.807s</span></span></code></pre></div><h4 id="测试" tabindex="-1">测试 <a class="header-anchor" href="#测试" aria-label="Permalink to &quot;测试&quot;">​</a></h4><p>报错显示网络设备不存在 <img src="`+p+`" alt=""></p><h3 id="移植网卡驱动" tabindex="-1">移植网卡驱动 <a class="header-anchor" href="#移植网卡驱动" aria-label="Permalink to &quot;移植网卡驱动&quot;">​</a></h3><p>设置 Ubuntu 的 IP 地址，新添加一个网络，手动分配地址</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">192.168.1.200</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;">#本机IP地址</span></span>
<span class="line"><span style="color:#FFCB6B;">255.255.255.0</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;">#子网掩码</span></span>
<span class="line"><span style="color:#FFCB6B;">192.168.1.1</span><span style="color:#A6ACCD;">    </span><span style="color:#676E95;font-style:italic;">#网关地址</span></span>
<span class="line"><span style="color:#FFCB6B;">8.8.8.8</span><span style="color:#A6ACCD;">        </span><span style="color:#676E95;font-style:italic;">#DNS</span></span></code></pre></div><p>开发板设置静态IP</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">setenv</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ipaddr</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">192.168</span><span style="color:#C3E88D;">.1.100</span><span style="color:#A6ACCD;">   </span><span style="color:#676E95;font-style:italic;">#设置开发板的 IP 地址</span></span>
<span class="line"><span style="color:#FFCB6B;">setenv</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">serverip</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">192.168</span><span style="color:#C3E88D;">.1.200</span><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;">#指定服务器 IP 地址</span></span>
<span class="line"><span style="color:#FFCB6B;">setenv</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">gatewayip</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">192.168</span><span style="color:#C3E88D;">.1.1</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;">#指定网络网关的 IP 地址</span></span>
<span class="line"><span style="color:#FFCB6B;">setenv</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">netmask</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">255.255</span><span style="color:#C3E88D;">.255.0</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;">#指定子网掩码</span></span>
<span class="line"><span style="color:#FFCB6B;">saveenv</span><span style="color:#A6ACCD;">                       </span><span style="color:#676E95;font-style:italic;">#保存设置</span></span></code></pre></div><p>测试开发板网络</p><blockquote><p>在开发板上 ping 服务器的 IP 地址</p></blockquote><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">ping</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">192.168</span><span style="color:#C3E88D;">.1.200</span></span></code></pre></div><p>显示结果如下，即为组内网成功</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">Using</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ethernet@5800a000</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">device</span></span>
<span class="line"><span style="color:#FFCB6B;">host</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">192.168</span><span style="color:#C3E88D;">.1.200</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">is</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">alive</span></span></code></pre></div><h4 id="测试-1" tabindex="-1">测试 <a class="header-anchor" href="#测试-1" aria-label="Permalink to &quot;测试&quot;">​</a></h4><p>报错显示由热插拔问题 <img src="`+o+`" alt=""></p><h3 id="解决热插拔问题" tabindex="-1">解决热插拔问题 <a class="header-anchor" href="#解决热插拔问题" aria-label="Permalink to &quot;解决热插拔问题&quot;">​</a></h3><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">Device</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Drivers</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">---</span><span style="color:#89DDFF;">&gt;</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">Generic</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Driver</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Options</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">---</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">            </span><span style="color:#89DDFF;">[*]</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">Support</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">for</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">uevent</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">helper</span><span style="color:#A6ACCD;">                                                           </span></span>
<span class="line"><span style="color:#A6ACCD;">                </span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">/sbin/hotplug</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">path</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">to</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">uevent</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">helper</span></span></code></pre></div><h4 id="测试-2" tabindex="-1">测试 <a class="header-anchor" href="#测试-2" aria-label="Permalink to &quot;测试&quot;">​</a></h4><p>成功进入linux内核 <img src="`+e+`" alt=""></p><h2 id="led例程-📣" tabindex="-1">LED例程 📣 <a class="header-anchor" href="#led例程-📣" aria-label="Permalink to &quot;LED例程  📣&quot;">​</a></h2><blockquote><p><strong>1. 内核裁剪指的是什么</strong> 需要模块进行编译，不需要的模块不进行编译 <strong>2. 如何对内核进行裁剪</strong> 通过make menuconfig命令</p></blockquote><h3 id="图形化界面信息配置" tabindex="-1">图形化界面信息配置 <a class="header-anchor" href="#图形化界面信息配置" aria-label="Permalink to &quot;图形化界面信息配置&quot;">​</a></h3><h3 id="驱动模块化编译" tabindex="-1">驱动模块化编译 <a class="header-anchor" href="#驱动模块化编译" aria-label="Permalink to &quot;驱动模块化编译&quot;">​</a></h3><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">0.在内核源码目录下，编译内核源码</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#F78C6C;">time</span><span style="color:#A6ACCD;"> make -j4 ARCH=arm uImage vmlinux dtbs LOADADDR=0xC2000000 </span></span>
<span class="line"><span style="color:#FFCB6B;">1.采用模块化方式进行编译</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">make</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-j4</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">modules</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">成功现象：</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">LD</span><span style="color:#A6ACCD;"> [M]  drivers/char/fsmp157a_led.ko</span></span>
<span class="line"><span style="color:#FFCB6B;">2.将linux内核源码编译生成的uImage镜像文件和设备树镜像文件拷贝到~/tftpboot目录下</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#82AAFF;">cd</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">~/FSMP1A/linux-stm32mp-5.10.61-stm32mp-r2-r0/linux-5.10.61</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">cp</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">arch/arm/boot/uImage</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">~/tftpboot/</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">cp</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">arch/arm/boot/dts/stm32mp157a-fsmp1a.dtb</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">~/tftpboot/</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">cp</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">drivers/char/fsmp157a_led.ko</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">~/nfs/rootfs</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">---------</span><span style="color:#89DDFF;">&gt;</span><span style="color:#C3E88D;">以及采用模块化方式编译的文件，拷贝到~/nfs/rootfs</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">3</span><span style="color:#C3E88D;">.设置bootcmd参数：自启动命令</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">FSMP1A&gt;</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">setenv</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">bootcmd</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">tftp</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0xc2000000</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">uImage</span><span style="color:#A6ACCD;">\\;</span><span style="color:#C3E88D;">tftp</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0xc4000000</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">stm32mp157a-fsmp1a.dtb</span><span style="color:#A6ACCD;">\\;</span><span style="color:#C3E88D;">bootm</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0xc2000000</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0xc4000000</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">FSMP1A&gt;</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">saveenv</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">Saving</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Environment</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">to</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">MMC...</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Writing</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">to</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">redundant</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">MMC</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">1</span><span style="color:#89DDFF;">)</span><span style="color:#C3E88D;">...</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">OK</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">4.设置bootargs参数：自启动参数</span></span>
<span class="line"><span style="color:#FFCB6B;">FSMP1A&gt;</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">setenv</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">bootargs</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">root=/dev/nfs</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nfsroot=</span><span style="color:#F78C6C;">192.168</span><span style="color:#C3E88D;">.1.250:/home/linux/nfs/rootfs,tcp,v4</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">rw</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">console=ttySTM0,115200</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">init=/linuxrc</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ip=</span><span style="color:#F78C6C;">192.168</span><span style="color:#C3E88D;">.1.100</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#FFCB6B;">FSMP1A&gt;</span><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">saveenv</span></span>
<span class="line"><span style="color:#FFCB6B;">Saving</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Environment</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">to</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">MMC...</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Writing</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">to</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">MMC</span><span style="color:#89DDFF;">(</span><span style="color:#FFCB6B;">1</span><span style="color:#89DDFF;">)</span><span style="color:#C3E88D;">...</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">OK</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">解释：</span></span>
<span class="line"><span style="color:#A6ACCD;">    root</span><span style="color:#89DDFF;">=</span><span style="color:#C3E88D;">/dev/nfs：使用nfs服务器</span></span>
<span class="line"><span style="color:#A6ACCD;">    nfsroot</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">192.168</span><span style="color:#C3E88D;">.1.250:/home/linux/nfs/rootfs：挂载的ip地址以及路径，每个人ip地址，以及路径需要编写自己设置！！！</span></span>
<span class="line"><span style="color:#A6ACCD;">     ip</span><span style="color:#89DDFF;">=</span><span style="color:#F78C6C;">192.168</span><span style="color:#C3E88D;">.1.100：板子的ip地址，每个人ip地址，需要编写自己设置！！！</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">5.重启开发板，进入自启动模式，安装led灯驱动</span></span>
<span class="line"><span style="color:#A6ACCD;">     </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@fsmp1a /</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"># insmod fsmp157a_led.ko </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">成功现象：[94.962918]</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">drivers/char/fsmp157a_led.c:demo_init:185</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#FFCB6B;">6.运行应用层程序</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">root@fsmp1a /</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"># ./a.out </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">成功现象：</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">100.453837</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">drivers/char/fsmp157a_led.c:demo_open:40</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">100.458299</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">status</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0x0</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">100.460470</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">status</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">0x30</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">100.462791</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">drivers/char/fsmp157a_led.c:demo_ioctl:107</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#FFCB6B;">7.卸载对应的驱动</span><span style="color:#A6ACCD;">    [root@fsmp1a </span><span style="color:#C3E88D;">/]#</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">rmmod</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">fsmp157a_led</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#89DDFF;">[</span><span style="color:#A6ACCD;">  </span><span style="color:#F78C6C;">114.686809</span><span style="color:#89DDFF;">]</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">drivers/char/fsmp157a_led.c:demo_exit:206</span></span></code></pre></div><h4 id="测试-3" tabindex="-1">测试 <a class="header-anchor" href="#测试-3" aria-label="Permalink to &quot;测试&quot;">​</a></h4><p><img src="`+t+`" alt=""></p><h2 id="编译过程-📣" tabindex="-1">编译过程 📣 <a class="header-anchor" href="#编译过程-📣" aria-label="Permalink to &quot;编译过程 📣&quot;">​</a></h2><blockquote><ol><li>vmlinux</li><li>objcopy</li><li>Image</li><li>gzip</li><li>arch/arm/boot/compressed/vmlinux</li><li>objcopy</li><li>zImage</li><li>mkimage</li><li>uImage</li></ol></blockquote><p>#待学习</p><p>执行命令</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">make</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">uImage</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">LOADADDR=</span><span style="color:#F78C6C;">0xC2000000</span></span></code></pre></div><p>arch/arm目录下，打开Makefile文件，搜索：uImage</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">315</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">BOOT_TARGETS</span><span style="color:#A6ACCD;">    </span><span style="color:#C3E88D;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">zImage</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Image</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">xipImage</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">bootpImage</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">uImage</span></span>
<span class="line"><span style="color:#FFCB6B;">323</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">$(</span><span style="color:#FFCB6B;">BOOT_TARGETS</span><span style="color:#89DDFF;">)</span><span style="color:#C3E88D;">:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">vmlinux</span></span>
<span class="line"><span style="color:#FFCB6B;">324</span><span style="color:#A6ACCD;">     </span><span style="color:#C3E88D;">@echo</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">$(</span><span style="color:#FFCB6B;">Q</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#FFCB6B;">325</span><span style="color:#A6ACCD;">     </span><span style="color:#C3E88D;">@echo</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">$(</span><span style="color:#FFCB6B;">MAKE</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#FFCB6B;">326</span><span style="color:#A6ACCD;">     </span><span style="color:#C3E88D;">@echo</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">$(</span><span style="color:#FFCB6B;">build</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#FFCB6B;">327</span><span style="color:#A6ACCD;">     </span><span style="color:#C3E88D;">@echo</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">$(</span><span style="color:#FFCB6B;">boot</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#FFCB6B;">328</span><span style="color:#A6ACCD;">     </span><span style="color:#C3E88D;">@echo</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">$(</span><span style="color:#FFCB6B;">MACHINE</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#FFCB6B;">329</span><span style="color:#A6ACCD;">     </span><span style="color:#C3E88D;">@echo</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">$(</span><span style="color:#FFCB6B;">boot</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;">                                                                                             </span></span>
<span class="line"><span style="color:#FFCB6B;">330</span><span style="color:#A6ACCD;">     </span><span style="color:#C3E88D;">@echo</span><span style="color:#A6ACCD;"> </span><span style="color:#A6ACCD;font-style:italic;">$@</span></span>
<span class="line"><span style="color:#FFCB6B;">331</span><span style="color:#A6ACCD;">     </span><span style="color:#89DDFF;">$(</span><span style="color:#FFCB6B;">MAKE</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">$(</span><span style="color:#FFCB6B;">build</span><span style="color:#89DDFF;">)</span><span style="color:#C3E88D;">=</span><span style="color:#89DDFF;">$(</span><span style="color:#FFCB6B;">boot</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">MACHINE=</span><span style="color:#89DDFF;">$(</span><span style="color:#FFCB6B;">MACHINE</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">$(</span><span style="color:#FFCB6B;">boot</span><span style="color:#89DDFF;">)</span><span style="color:#C3E88D;">/</span><span style="color:#A6ACCD;font-style:italic;">$@</span></span>
<span class="line"><span style="color:#FFCB6B;">332</span><span style="color:#A6ACCD;">     </span><span style="color:#C3E88D;">@</span><span style="color:#89DDFF;">$(</span><span style="color:#FFCB6B;">kecho</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">  Kernel: $(boot)/$@ is ready</span><span style="color:#89DDFF;">&#39;</span></span></code></pre></div><h3 id="kbuild-include" tabindex="-1">Kbuild.include <a class="header-anchor" href="#kbuild-include" aria-label="Permalink to &quot;Kbuild.include&quot;">​</a></h3><p>打开 Kbuild.include文件，查看编译过程</p><p><img src="`+c+'" alt=""></p><h3 id="makefile-lib" tabindex="-1">Makefile.lib <a class="header-anchor" href="#makefile-lib" aria-label="Permalink to &quot;Makefile.lib&quot;">​</a></h3><p>检查加载地址</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">@$(check_for_multiple_loadaddr</span><span style="color:#A6ACCD;">)</span></span></code></pre></div><p>call是调用命令，调用if_changed命令</p><ul><li>Makefile.lib中包含了一些共用的编译规则和函数，用于简化内核代码的编译过程，其中就含有 cmd_uimage</li></ul><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">$(</span><span style="color:#FFCB6B;">call</span><span style="color:#C3E88D;"> if_changed,uimage</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> ——————————————</span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;">执行cmd_uimage</span></span></code></pre></div><p><strong>uImage是通过zImage得到，将zImage通过 mkimage这个工具添加64字节头部信息</strong></p><h3 id="arch-arm-boot-makefile" tabindex="-1">arch/arm/boot/Makefile <a class="header-anchor" href="#arch-arm-boot-makefile" aria-label="Permalink to &quot;arch/arm/boot/Makefile&quot;">​</a></h3><p>打开 arch/arm/boot/Makefile 文件，找到目标 <img src="'+C+'" alt=""></p><p><strong>arch/arm/boot/compressed/vmlinux通过objcopy命令格式化转换为zImage</strong></p>',76),D=[y];function A(i,F,d,B,m,E){return a(),n("div",null,D)}const g=s(r,[["render",A]]);export{u as __pageData,g as default};
